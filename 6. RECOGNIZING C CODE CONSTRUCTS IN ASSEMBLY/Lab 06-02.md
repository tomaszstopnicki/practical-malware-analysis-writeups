## Lab 06-02

Analyze the malware found in the file Lab06-02.exe

## 1. What operation does the first subroutine called by main perform?

In the first subroutine (sub_401000) called by main we can find a call to InternetGetConnectedState followed by if construct. The code does exactly the same what code in the first exercise of this chapter (Lab 6-1, exercise 1).

## 2. What is the subroutine located at 0x40117F? 

Same as above, it was already answered in the Lab 6-1, exercise 2&3).

To confirm that even further let’s check xrefs of sub at 0x40117F.

![image](https://github.com/user-attachments/assets/d8dec46e-58a9-476b-8ff3-6f3c25e50271)


Each of call to sub_401040 is preceded by pushing string into the stack. We can find there strings like: “Error 2.1: Fail to OpenUrl\n”, “Error 2.2: Fail to ReadFile\n”, “Error 2.3: Fail to get command\n”. This confirms that the call to sub_401040 is intended to print out the result to the console.

## 3. What does the second subroutine called by main do?

![image](https://github.com/user-attachments/assets/a821e790-8224-4f04-8f62-ff6f67ddedcb)


Second subroutine is sub_401040. Let’s dive deeper into it.

![image](https://github.com/user-attachments/assets/c5bbf701-74a5-4488-97ce-931b04478682)

In this subroutine we can find a call to InternetOpenA that opens as an “Internet Explorer 7.5/pma” using wininet library. Then it proceeds to open an url <http://www.practicalmalwareanalysis.com/cc.htm> using InternetOpenUrlA. 

If the call doesn’t succeed, it returns null value, and as we can see the eax result gets written into hFile and then compared with 0 followed by jnz instruction.

If the result is 0, then it proceeds to print a message “Error 2.1: Fail to OpenUrl\n” and then calls InternetCloseHandle to close the connection.

If the result is different than 0 – which is our handle to the URL, then it goes to loc_40109D:

![image](https://github.com/user-attachments/assets/3800d3a7-bb79-439c-a859-da6f905ae332)


This code is designed to read the data of the provided handle in hFile variable.

As in the previous part – if the file read is unsuccessful then it prints “Error 2.2: Fail to ReadFile\n” and closes the handle.

If the InternetReadFile is successful then it downloads the script.

To summarize, the second subroutine in the main is intended to connect to an url  and download the script.

## 4. What type of code construct is used in this subroutine?

The sub_401040 uses if statements comparing to InternetReadFile result, HTML parsing ‘<’, ‘!’, ‘-‘ which sign <!-- the beginning of comment.

## 5. Are there any network-based indicators for this program?

A network-based indicator might be:

- a connection to [http://www.practicalmalwareanalysis.com/cc.htm  ](http://www.practicalmalwareanalysis.com/cc.htm%20%20)at a default port 80,
- an useragent Internet Explorer 7.5/pma

![image](https://github.com/user-attachments/assets/3f72fa9a-5a4c-4c43-982d-6076366f3cc7)

![image](https://github.com/user-attachments/assets/f9f42a2a-e4f5-4b9e-92bf-e143eed1f546)



## 6. What is the purpose of this malware?

Let’s summarize what this malware does step by step:

- Checks for an internet connection
- Connects to a host
- Reads a HTML comment

This malware is small and intended for one thing – connecting to a host and getting the information from HTML code that starts with <!--.

