## Lab 03-04

Virustotal gives the file score of **56/72** and tells us that it might be a downloader type of malware.

**MD5:** `b94af4a4d4af6eac81fc135abda1c40c`

**SHA-256:** `6ac06dfa543dca43327d55a61d0aaed25f3c90cce791e0555e3e306d47107859`

Let’s analyze if the file is compressed or obfuscated in any way.

- PEiD tells it’s not compressed.
- Section headers sizes are correct
- Libraries are visible, along with functions
- Strings are clearly readable

File seems to not be protected against static analysis.

There are 4 libraries, I will list most flag functions:

** 1) KERNEL32.dll**
- VirtualAlloc
- WriteFile
- DeleteFileA
- CreateProcessA
- TerminateProcess
- GetCurrentProcess
- GetExitCodeProcess
- GetEnvironmentStrings
- GetEnvironmentStringsW
- SetEnvironmentVariableA
- GetEnvironmentVariableA

** 2) ADVAPI32.dll**
- ChangeServiceConfigA
- CreateServiceA
- DeleteService
- RegDeleteValueA
- RegCreateKeyExA
- RegSetValueExA

** 3) SHELL32.dll**
- ShellExecuteA

** 4) WS_32.dll**



**Strings analysis:**

- command.com
- COMSPEC
- Ppxxxx
- SunMonTueWedThuFriSat
- JanFebMarAprMayJunJulAugSepOctNovDec
- .com
- .bat
- .cmd
- HTTP/1.0
- DOWNLOAD                                                                                                   
- UPLOAD   
- SOFTWARE\Microsoft \XPS
- -cc
- -re
- -in
- <http://www.practicalmalwareanalysis.com>
- %SYSTEMROOT%\system32\


## Dynamic analysis:

Before opening the file I have prepared: procmon, procexp, Regshot and FakeNET.

**Procmon analysis:**

- Malware deleted the original executable through cmd command /c del
- Created a file in Windows/Prefetch directory under a name LAB03-04.EXE-00BF68FE.pf (not the same as original file, different hashes, sizes) 

**Regshot analysis:**

**Added keys:**

- `HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY\_FASTFAT\0000\Control`
- `HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY\_FASTFAT\0000\Control`

**Added values:**

- `HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY\_FASTFAT\0000\Control\ActiveService: "Fastfat"`
- `HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY\_FASTFAT\0000\Control\ActiveService: "Fastfat"`
- `HKU\S-1-5-21-854245398-507921405-1417001333-500\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{75048700-EF1F-11D0-9888-006097DEACF9}\Count\HRZR\_EHACNGU:P:\Qbphzragf naq Frggvatf\Nqzvavfgengbe\Qrfxgbc\OvanelPbyyrpgvba\Puncgre\_3Y\Yno03-04.rkr:  01 00 00 00 06 00 00 00 20 15 BC F5 0A 7D DA 01`

**Modified files:**

- `C:\Documents and Settings\Administrator\ntuser.dat.LOG`
- `C:\WINDOWS\Prefetch\CMD.EXE-087B4001.pf `
- `C:\WINDOWS\system32\config\software.LOG`
- `C:\WINDOWS\system32\config\system.LOG`

Procexp reveals nothing noteworthy; the cmd process appears briefly before termination.

Despite running malware for nearly two hours, FakeNET displays no network activity whatsoever.

## 1. What happens when you run this file?

File removes itself after execution, runs .cmd process for a second, then kills it. 

The malware does some registry entry. There is no network activity despite having imported network library and website address in strings.

It creates a file in Windows/Prefetch directory under a name LAB03-04.EXE-‘%%%%%%%%.pf  where a % is a single digit or a letter. It chooses the name randomly.

Looks like the malware is either on hibernate because of the environment, or has to be ran in some other way than just executing it, probably with some arguments.

## 2. What is causing the roadblock in dynamic analysis?

The roadblock is caused by lack of any active process. The only process it creates is cmd that gets process killed immediately.

## 3. Are there other ways to run this program?

Things I tried without any success:

- Examining the extension of file : LAB03-04.EXE-‘%%%%%%%%.pf in hope to run it later, but it’s not a PE file
- Trying the arguments provided in strings

I suppose that it might be checking for actively running analysis tools or if the malware is tried to be ran on a virtual machine.

