## Lab 03-03

**Checking the file in virustotal tells us that file is some kind of keylogger.**

**MD5:** `e2bf42217a67e46433da8b6f4507219e`

**SHA-256:** `ae8a1c7eb64c42ea2a04f97523ebf0844c27029eb040d910048b680f884b9dce`

After checking the file in PEiD, comparing the virtual and raw sizes, checking imports and strings I can tell that file is not packed.


**Imported library:**

**a) KERNEL32.dll**

The malware imports a lot of functions from the library, so I will filter the most interesting ones:

- GetThreadContext
- VirtualAlloc
- WriteProcessMemory
- VirtualAllocEx
- ReadProcessMemory
- WriteFile
- SetThreadContext
- CreateProcessA
- TerminateProcess
- GetCurrentProcess
- GetEnvironmentStrings
- GetEnvironmentStringsW
- GetSystemDirectoryA
- CreateProcessA
- Sleep

**Strings:**

As with the imported functions, there are also a lot of strings, I will filter the most interesting ones to me.

- UNICODE
- LOCALIZATION
- Ext!!
- ntdll.dll
- \svchost.exe
- HeapAlloc
- HeapDestroy
- HeapCreate
- HeapFree
- FreeResource
- SizeofResource
- LockResource
- LoadResource
- FindResourceA
- User32.dll

Analyzing the information above we can clearly tell that there are some dynamically added libraries.

The next thing I have noticed is that there is one entry in the resource directory named **‘UNICODE’** inside of it is another directory called **‘LOCALIZATION’**. I tried to dump the resource into .bin format and then proceed a static analysis upon it, but zero success.

## Let’s proceed now to dynamic analysis.

I’m running the file with opened Regshot, procmon and procexp and a FakeNET.

Procexp shows that file hides under svchost.exe and is allowing to run multiple times. When I tried to compare two svchost.exe files (image to memory) I found a new string (**practicalmalwareanalysis.log**):

![image](https://github.com/tomaszstopnicki/practical-malware-analysis-writeups/assets/163318997/d79bbba5-db8d-41a9-aa3e-af14c4ce34e3)

The malware creates a file **practicalmalwareanalysis.log** in the malware’s first run directory after the first keystore was captured. It records all of the pressed keys along with the current active window info.

![image](https://github.com/tomaszstopnicki/practical-malware-analysis-writeups/assets/163318997/9b0339a7-628a-40b8-bf83-ac6f21d7ac9d)

Regshot shows that it created several registry entries, there is one that provides specific file:

`HKU\S-1-5-21-1417001333-1708537768-854245398-500\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{75048700-EF1F-11D0-9888-006097DEACF9}\Count\HRZR\_EHACNGU:P:\Qbphzragf naq Frggvatf\Nqzvavfgengbe\Chycvg\Yno03-03.rkr:  02 00 00 00 06 00 00 00 C0 41 5D 8B CD 7A DA 01`

UserAssist keeps track of program execution counts. It records when and how often programs are executed. The sequence of symbols at the end might be HEX memory values. Probably for modification.

![image](https://github.com/tomaszstopnicki/practical-malware-analysis-writeups/assets/163318997/c4c96113-efc2-4013-bfc9-195c667d4393)

The FakeNET shows zero network activity, I didn’t see any network related library/functions aswell.

## 1. What do you notice when monitoring this malware with Process Explorer?

The first thing I noticed when I started to monitor the malware is that it defines a string **‘practicalmalwareanalysis.bin’**, the other thing I noticed is that it has multiple constant defined mutexes.	

Surprisingly, we can run multiple instances at the same time, and they all work independently.

## 2. Can you identify any live memory modifications?

My only idea to identify it is through the Regshot output.

- `HKU\S-1-5-21-1417001333-1708537768-854245398-500\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{75048700-EF1F-11D0-9888-006097DEACF9}\Count\HRZR\_EHACNGU:  02 00 00 00 2A 00 00 00 B0 98 2B 7B CD 7A DA 01`

## 3. What are the malware’s host-based indicators?

There are several host-based indicators:

- The existence of file **‘practicalmalwareanalysis.log’** on the disk,
- Existence of file **Yno03-03.rkr,**
- Same mutants for every instance of the malware:

![image](https://github.com/tomaszstopnicki/practical-malware-analysis-writeups/assets/163318997/f5d5c1ce-678c-4f06-b47f-4719e2dd9f09)


## 4. What is the purpose of this program?

Program records keystrokes and saves it into a **‘practicalmalwareanalysis.bin’** file in a malware directory. That kind of malware is called keylogger. 
